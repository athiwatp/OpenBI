<%- include header.html %>
<div>
	<ul class='title'>
		<li>
			<a href="#drawer" id='navicon' data-uk-offcanvas
				class="uk-icon-button uk-icon-bars"></a>
		</li>
		<li>
			<a href="/" class="uk-icon-button uk-icon-home"></a>
		</li>
		<li>
			<a href="javascript:location.reload()"
				class="uk-icon-button uk-icon-refresh"></a>
		</li>
		<% if (user !== 0) { %>
		<li>
			<a href='javascript:createChart({})'
				class="uk-icon-button uk-icon-plus"></a>
		</li>
		<li>
			<a href='javascript:documentSaveLayout()'
				class="uk-icon-button uk-icon-save"></a>
		</li>
		<li>
			<a href="#settings" data-uk-modal
				class="uk-icon-button uk-icon-gears"></a>
		</li>
		<% } %>
		<li>
			<!-- <h2 style='margin:0; text-shadow: 0 1px white;'> -->
			<%= document.name %>
		</li>
	</ul>
</div>

<div id='ruler'>
	<span class='item' style='left:320px;'  >320</span>
	<span class='item' style='left:480px;'  >480</span>
	<span class='item' style='left:640px;'  >640</span>
	<span class='item' style='left:768px;'  >768</span>
	<span class='item' style='left:1024px;'>1024</span>
	<span class='item' style='left:1280px;'>1280</span>
	<span class='item' style='left:1600px;'>1600</span>
	<span class='item' style='left:1920px;'>1920</span>
</div>

<script type="text/html" id="chart-template">
<div class='chart' id='chart_id'>
	<span class='handle'>
		<span class='title'></span>
		<span class='button'>
			<i class="uk-icon-gears" onclick='javascript:chartSettings(_id)'></i>
		</span>
	</span>
</div>
</script>

<%- include chart-settings.html %>
<%- include document-settings.html %>

<script src="/js/absolute.js"></script>

<script>
"use strict;"

var doc_s = '<%= document.id %>';
var doc = doc_s === '' ? 0 : parseInt(doc_s);
var charts = new Array();
var data;
var xf;
var dimension;
var group;
var columns;
<%
	var init = document.init;
	// escape for " not need for ' < >
	init = init.replace(/\r/g, '');
	init = init.replace(/"/g, "\\\"");
	var lines = init.split('\n');
	init = "";
	for (var i = 0; i < lines.length; i++) {
		init += '"' + lines[i] + '\\n" + ';
	}
	init += '""';
%>

var init = <%- init %>;

function main() {
	$('.chart').remove();
	while (charts.length > 0) {
		charts.pop();
	}

	// TODO: load charts from ajax not the backend code
	<% for (var i = 0; i < charts.length; i++) { %>
		createChart({
			id:		<%= charts[i].id %>,
			name:		'<%= charts[i].name %>',
			type:		'<%= charts[i].type %>',
			dimension:	'<%= charts[i].dimension %>',
			group:		'<%= charts[i].reduce %>',
			sort:		'<%= charts[i].sort %>',
			top:		'<%= charts[i].top %>',
			top_value:	'<%= charts[i].top_value %>',
			x:		<%= charts[i].x %>,
			y:		<%= charts[i].y %>,
			width:	<%= charts[i].width %>,
			height:	<%= charts[i].height %>
		});
	<% } %>

	restart();
}

function restart() {
	createCrossFilter("/data/<%= document.id %>");
}

$(document).ready(function() {
	$('body').on('mouseup', function() {
		snapAll();
		$('#ruler').fadeOut();
	});
	main();
});

</script>

<%- include drawer.html %>
<%- include footer.html %>
