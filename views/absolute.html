<%- include header.html %>

<script src="/js/absolute.js"></script>
<style>
body {
	background: #eee;
}
</style>

<div class='uk-container'>
	<ul class='title'>
		<li>
			<a href="#drawer" class="uk-icon-button uk-icon-navicon" 
			   id='navicon' data-uk-offcanvas></a>
		</li>
		<li>
			<a href="/" class="uk-icon-button uk-icon-home"></a>
		</li>
		<li>
			<a href="" class="uk-icon-button uk-icon-refresh"
				onclick='javascript:createCrossFilter()'></a>
		</li>
		
		<% if (user === dashboard.user) { %>
		<li>
			<a href="" class="uk-icon-button uk-icon-plus"
				onclick='javascript:createChart({})'></a>
		</li>
		
		<li>
			<a href="" class="uk-icon-button uk-icon-save"
				onclick='javascript:saveLayout()'></a>
		</li>
		<li>
			<a href="#settings" class="uk-icon-button uk-icon-gears"
				data-uk-modal></a>
		</li>
		<% } %>
		
		<!-- <li style='width:2rem;'></li> -->
		<li style=''>
			<h2 style='margin:0; text-shadow: 0 1px white;'>
				<%= dashboard.name %>
			</h2>
		</li>
	</ul>
</div>

<script type="text/html" id="chart-template">
<div class='chart ui-widget-content' id='chart_id'>
	<span class='handle'>
		<span class='title'></span>
		<span class='button'>
		<i class="uk-icon-gears" onclick='javascript:chartSettings(_id)'></i>
		<i class="uk-icon-trash-o" onclick='javascript:chartDelete(_id)'></i>
		</span>
	</span>
</div>
</script>

<div id="chart-settings" class="uk-modal" data-chart-id="0">
	<div class="uk-modal-dialog">
		<a class="uk-modal-close uk-close"></a>
		<h1>Settings</h1>
		<form class="uk-form" action="javascript:chartSave()">
			<input type="hidden" name="id" value="0" />
			<div class="uk-grid uk-grid-preserve">
				
				<div class="uk-width-1-3">
					Name
				</div>
				<div class="uk-width-2-3">
					<input class="uk-width-1-1" type="text" name="name" 
						   autofocus />
				</div>
				
				<div class="uk-width-1-3">
					Chart Type
				</div>
				<div class="uk-width-2-3">
					<select class="uk-width-1-1" name="type">
						<option value="none">None</option>
						<option value="pie">Pie</option>
						<option value="row">Row</option>
						<option value="bar">Bar</option>
						<option value="line">Line</option>
					</select>
				</div>
				
				<div class="uk-width-1-3">
					Dimension
				</div>
				<div class="uk-width-2-3">
					<input class="uk-width-1-1" type="text" name="dimension" />
				</div>
				
				<div class="uk-width-1-3">
					Group
				</div>
				<div class="uk-width-2-3">
					<input class="uk-width-1-1" type="text" name="group" />
				</div>
				
				<div class="uk-width-1-3"></div>
				<div class="uk-width-2-3">
					<input type="submit" value="Save" 
					   class="uk-button uk-button-primary" />
				</div>
			</div>
			
		</form>
	</div>
</div>

<script>

$(document).ready(function() {
	main();
});

function main() {
	// TODO: load charts from ajax not the backend code
	<% for (var i = 0; i < charts.length; i++) { %>
		createChart({ 
			id:		<%= charts[i].id %>,
			name:		'<%= charts[i].name %>',
			type:		'<%= charts[i].type %>',
			dimension:	'<%= charts[i].dimension %>',
			group:		'<%= charts[i].reduce %>',
			x:		<%= charts[i].x %>,
			y:		<%= charts[i].y %>,
			width:	<%= charts[i].width %>,
			height:	<%= charts[i].height %>
		});
	<% } %>

	createCrossFilter();
}

var dashboard_ = '<%= dashboard.id %>';
var dashboard = dashboard_ === '' ? 0 : parseInt(dashboard_);
var charts = new Array();

var data;
var xf;
var dimension;
var group;
var keys;

function createCrossFilter() {
	// TODO: load data only first time then
	// create data preparation, get the available dimension
	// display dimension & group to user
	d3.csv("/data/<%= dashboard.id %>", function(data_) {
		data = data_;
		xf = crossfilter(data);
		dimension = new Array();
		group = new Array();
		keys = new Array();
		for (var k in data[0]) {
			keys.push(k);
		}
		
		for (var i = 0; i < charts.length; i++) {
			
			dimension[i] = xf.dimension(dc.pluck(charts[i].dimension));
			group[i] = dimension[i].group().reduceSum(
					dc.pluck(charts[i].group));

			var width  = $('#chart' + i).outerWidth();
			var height = $('#chart' + i).outerHeight();
			height -= _chart_padding;
			var square = Math.min(width, height);
			var transitionDuration = 1000;
			
			if (charts[i].type === 'pie') {
				charts[i].chart = dc.pieChart("#chart" + i)
					.width(width)
					.height(height - _chart_padding)
					.dimension(dimension[i])
					.group(group[i])
					.radius(square / 2 - _chart_padding)
					.innerRadius(square / 10)
					.transitionDuration(transitionDuration)
					// .legend(dc.legend())
					;
			}
			else
			if (charts[i].type === 'row') {
				charts[i].chart = dc.rowChart('#chart' + i)
					.width(width)
					.height(height - _chart_padding)
					.dimension(dimension[i])
					.group(group[i])
					.elasticX(true)
					.transitionDuration(transitionDuration)
					;
			}
			else
			if (charts[i].type === 'line') {
				charts[i].chart = dc.lineChart('#chart' + i)
					.width(width)
					.height(height - _chart_padding)
					.dimension(dimension[i])
					.group(group[i])
					.elasticY(true)
					.transitionDuration(transitionDuration)
					.brushOn(true)
					.x(d3.scale.ordinal())
					.xUnits(dc.units.ordinal)
					;
			}
			else
			if (charts[i].type === 'bar') {
				charts[i].chart = dc.barChart('#chart' + i)
					.width(width)
					.height(height - _chart_padding)
					.dimension(dimension[i])
					.group(group[i])
					.centerBar(true)
					.brushOn(true)
					.elasticY(true)
					.transitionDuration(transitionDuration)
					.x(d3.scale.ordinal())
					.xUnits(dc.units.ordinal)
					.renderHorizontalGridLines(true)
					.barPadding(1)
					.outerPadding(.5)
					.gap(1)
					;
			}
		}
		
		dc.renderAll();
/*
		// rotate the x Axis labels
		d3.selectAll("g.x text")
			.attr("class", "campusLabel")
			.style("text-anchor", "end") 
			.attr("transform", "translate(-10,0)rotate(315)");

		d3.selectAll("g.row").call(tip);
		d3.selectAll("g.row").on('mouseover', tip.show)
			.on('mouseout', tip.hide);

		d3.selectAll(".pie-slice").call(pieTip);
		d3.selectAll(".pie-slice").on('mouseover', pieTip.show)
			.on('mouseout', pieTip.hide);

		d3.selectAll(".bar").call(barTip);
		d3.selectAll(".bar").on('mouseover', barTip.show)
			.on('mouseout', barTip.hide);  
*/



	});

}

</script>

<!--
dc.dataCount("#data-count")
	.dimension(xf)
	.group(group[0])
	.html({
		some:"<strong>%filter-count</strong> selected out of 
<strong>%total-count</strong> records | 
<a href='javascript:dc.filterAll(); dc.renderAll();''>Reset All</a>",
		all:"All records selected. Please click on the graph to apply filters."
	});

<div id="data-count" style="z-index: 2000;">
<span class="filter-count"></span> selected out of 
<span class="total-count"></span> records
</div>
-->

<div id="settings" class="uk-modal">
	<div class="uk-modal-dialog">
		<a class="uk-modal-close uk-close"></a>
		<h1>Settings</h1>
		
		<form class='uk-form' action='javascript:saveSettings()'>
			<div class='uk-grid uk-grid-preserve'>
				<div class='uk-width-3-10'>
					<label>Name</label>
				</div>
				<div class='uk-width-7-10'>
					<input type='text' name='name' class='uk-width-1-1'
					   value='<%= dashboard.name %>' />
				</div>
				<div class='uk-width-3-10'>
					<label>Public</label>
				</div>
				<div class='uk-width-7-10'>
					<input type='checkbox' name='public' 
						<%= dashboard.public ? 'checked' : '' %> />	
				</div>
				
				<div class='uk-width-1-1'>&nbsp;</div>
				
				<div class='uk-width-1-1'>
					<input type='submit' value='Save'
					   class='uk-button uk-button-primary' />
					<input type='button' value='Cancel'
					   class='uk-button' onclick='javascript:closeSettings()' />
					<input type='hidden' />
				</div>
			</div>
		</form>
	</div>
</div>

<%- include drawer.html %>
<%- include footer.html %>
